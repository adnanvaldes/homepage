<!DOCTYPE html>
<html lang="en">
      <head>
      <title>Adnan</title>
      <meta name="charset" charset="utf-8" />
      <meta name="generator" content="Pelican"/>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" href="../theme/css/rdark.css" />
	    <link rel="stylesheet" type="text/css" href="../theme/css/main.css" />
      <link href="../" type="application/atom+xml" rel="alternate" title="Adnan Valdes ATOM Feed" />
        <link href="https://adnanvaldes.pages.dev/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Adnan Valdes Full Atom Feed" />
        <link href="https://adnanvaldes.pages.dev/feeds/feed.rss" type="application/rss+xml" rel="alternate" title="Adnan Valdes Full RSS Feed" />
    </head>




    <meta name="tags" content="programming" />

  <body>
    <nav class="nav">
      <ul class="nav__ul">
        [
          <li>
            <a href="https://adnanvaldes.pages.dev">Home</a>
          </li>
        ]
        [
          <li>
            <a href="feeds/atom.xml">RSS</a>
          </li>
        ]
        [
          <li>
            <a href="resume.html">Resume</a>
          </li>
        ]
        [
          <li>
            <a href="archives.html">Archive</a>
          </li>
        ]
      </ul>
    </nav>
    <header class="header">
      <h1 class="header__h1">
        <a href="../">Adnan Valdes</a>
      </h1>
  </header>
  <main>
  <article>
    <header>
      <h2>
        <a href="../drafts/202208241158.html" rel="bookmark"
           title="Permalink to Git">Git</a></h2>
      
    </header>
    <h4>Using Github</h4>
<p>By default Github will use SSH to clone repositories. It defaults to using <code>git@github.com</code> as a user with the default <code>id_rsa</code> key. To override this we can add the following to our git config:</p>
<p>```git config
  38   │ Host github
  39   │     User git
  40   │     Hostname github.com
  41   │     IdentityFile ~/.ssh/github
  42   │     IdentitiesOnly yes</p>
<div class="highlight"><pre><span></span><code><span class="n">This</span><span class="w"> </span><span class="n">way</span><span class="p">,</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">clone</span><span class="o">/</span><span class="k">commit</span><span class="w"> </span><span class="n">commands</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">done</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="err">`</span><span class="n">git</span><span class="w"> </span><span class="n">clone</span><span class="w"> </span><span class="nl">github</span><span class="p">:</span><span class="k">user</span><span class="o">/</span><span class="n">repo</span><span class="err">`</span><span class="w"> </span><span class="n">rather</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="err">`</span><span class="n">git</span><span class="w"> </span><span class="n">clone</span><span class="w"> </span><span class="n">git</span><span class="nv">@github</span><span class="p">.</span><span class="nl">com</span><span class="p">:</span><span class="k">user</span><span class="o">/</span><span class="n">repo</span><span class="err">`</span>

<span class="err">####</span><span class="w"> </span><span class="n">Git</span><span class="w"> </span><span class="n">repositories</span>
<span class="ow">In</span><span class="w"> </span><span class="n">git</span><span class="p">,</span><span class="w"> </span><span class="n">repositories</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">made</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="nl">things</span><span class="p">:</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ss">&quot;work tree&quot;</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="n">meant</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="n">controlled</span><span class="w"> </span><span class="n">live</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ss">&quot;git directory&quot;</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">Git</span><span class="w"> </span><span class="n">stores</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">own</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="w"> </span><span class="n">So</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">working</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">specific</span><span class="w"> </span><span class="n">project</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="ss">&quot;work tree&quot;</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">generally</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="k">structure</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="n">our</span><span class="w"> </span><span class="k">work</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">generally</span><span class="w"> </span><span class="n">interact</span><span class="w"> </span><span class="k">with</span><span class="p">.</span>

<span class="k">On</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">hand</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="ss">&quot;git directory&quot;</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="n">directory</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="ss">&quot;work tree&quot;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">it</span><span class="s1">&#39;s the place where objects and tracking data is stored (after all, the files we work on themselves will probably not be equipped to handle version controls).</span>

<span class="s1">A git directory,then, contains the following:</span>

<span class="s1">```python</span>
<span class="s1"># .git/            - the git directory itself</span>
<span class="s1"># .git/objects/    - the object store</span>
<span class="s1"># .git/refs/       - the reference store, which contains &#39;</span><span class="n">heads</span><span class="s1">&#39; and &#39;</span><span class="n">tags</span><span class="s1">&#39;</span>
<span class="s1"># .git/HEAD        - a reference to current HEAD</span>
<span class="s1"># .git/config      - the repo&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="k">file</span>
<span class="err">#</span><span class="w"> </span><span class="p">.</span><span class="n">git</span><span class="o">/</span><span class="n">description</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">repo</span><span class="err">&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="k">file</span>
</code></pre></div>

<p>In most git programs, running <code>init</code> will create a <code>.git</code> directory with all of the above.</p>
<p>The <code>description</code> file is only used by the GitWeb program to generate a description of the repository when browsing through a web interface. The <code>config</code> file contains project-specific configuration options.</p>
<p>The <code>objects</code>, <code>refs</code>, and <code>HEAD</code> are the core part of a git repository. <code>./objects/</code> stores all the content of the database, while <code>./refs./</code> stores pointers to commit objects in that data (things like branches, tags, etc.). Lastly, <code>HEAD</code> is a file that simply points to the current checked out branch.</p>
<p>There is another file called <code>index</code> that can be created to store staging area information.</p>
<h4>What are Git objects?</h4>
<p>There are four types of git objects: <code>blobs</code>, <code>tags</code>, <code>trees</code>, and <code>commits</code>.</p>
<p>At its core, Git is a "content-addressed filesystem". This means that the name (or address) of any given objects is derived from the content of the file itself through a mathematical algorithm; this is unlike regular filesystems that can have arbitrary file names. </p>
<p>The implication of this is that when even a single byte of data changes within a file the internal name of that file will also change. As a result, files are not technically <em>modified</em> but always <em>created</em> in a different location. And so, git objects are simply files in a git repository whose paths are determined by their contents. It is also worth noting that most other items in git are objects too, such as commits and tags.</p>
<p>When creating a git object, the storage format will look like so:</p>
<div class="highlight"><pre><span></span><code><span class="mf">00000000</span><span class="w">  </span><span class="mf">63</span><span class="w"> </span><span class="mf">6</span><span class="n">f</span><span class="w"> </span><span class="mf">6</span><span class="n">d</span><span class="w"> </span><span class="mf">6</span><span class="n">d</span><span class="w"> </span><span class="mf">69</span><span class="w"> </span><span class="mf">74</span><span class="w"> </span><span class="mf">20</span><span class="w"> </span><span class="mf">31</span><span class="w">  </span><span class="mf">30</span><span class="w"> </span><span class="mf">38</span><span class="w"> </span><span class="mf">36</span><span class="w"> </span><span class="mf">00</span><span class="w"> </span><span class="mf">74</span><span class="w"> </span><span class="mf">72</span><span class="w"> </span><span class="mf">65</span><span class="w"> </span><span class="mf">65</span><span class="w">  </span><span class="err">|</span><span class="n">commit</span><span class="w"> </span><span class="mf">1086.</span><span class="n">tree</span><span class="err">|</span>
</code></pre></div>

<p>Here we see the type header (<code>00000000</code>), an ASCII space (<code>0x20</code>), then the size of the object in ASCII (<code>63 6f 6d 6d 69 74 20 31  30 38 36 00 74 72 65 65</code>) - in this case 1086 - and then a null byte (<code>0x00</code>). The last four bytes are the beginning of that objects contents, <code>tree</code> in this case. If converted from hex (with <code>0x</code> removed) to ASCII, the line above is converted to everything past the <code>65</code> byte:</p>
<div class="highlight"><pre><span></span><code><span class="mi">00000000</span>  <span class="mi">63</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">6</span><span class="n">d</span> <span class="mi">6</span><span class="n">d</span> <span class="mi">69</span> <span class="mi">74</span> <span class="mi">20</span> <span class="mi">31</span>  <span class="mi">30</span> <span class="mi">38</span> <span class="mi">36</span> <span class="mi">00</span> <span class="mi">74</span> <span class="mi">72</span> <span class="mi">65</span> <span class="mi">65</span> <span class="c1"># Byte stream</span>
<span class="err">    </span>  <span class="n">c</span> <span class="n">o</span> <span class="n">m</span> <span class="n">m</span> <span class="n">i</span> <span class="n">t</span>   <span class="mi">1</span>  <span class="mi">0</span> <span class="mi">8</span> <span class="mi">6</span> <span class="err"> </span> <span class="n">t</span> <span class="n">r</span> <span class="n">e</span> <span class="n">e</span>  <span class="c1"># Byte stream converted in ASCII</span>
</code></pre></div>

<p>The path to any particular object is computed by using the SHA-1 [[Hash Functions|hash]] of that file's content. Once the hash is computed, git will use the first two characters as a directory name and the rest as a file name - which allows for 256 intermediate directories, and it is used to avoid having too many files in a single directory. The directory path will then be the first two characters of the hash, a directory limiter, and then the remaining part:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># path to object `e673d1b7eaa0aa01b5bc2442d570a765bdaae751` is</span>
<span class="c1"># `.git/objects/e6/73d1b7eaa0aa01b5bc2442d570a765bdaae751`</span>
</code></pre></div>

<p>*Note: As of <a href="https://github.com/git/git/blob/26e47e261e969491ad4e3b6c298450c061749c9e/Documentation/technical/hash-function-transition.txt#L34-L36">Git v2.13.0 </a>Git does not use SHA-1 but a hardened version called New Hash that produces the exact same results while avoiding collisions generated by <a href="https://shattered.io/">SHAttered</a> attacks</p>
<p>To write software that runs a git program, it must be able to handle git objects. In general, all git objects share the same retrieval/storage mechanisms as well as the same header format. However, because there are multiple object <code>types</code>, we must implement object-specific functionality on a case by case basis. As a result, we can start with an abstracted version of a <code>GitObject</code> that itself can form the basis for other objects:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">GitObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A generic git object that can then be subclasses for specific object types, since</span>
<span class="sd">    every object has the same storage/retrieval mechanism.&quot;&quot;&quot;</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span> <span class="o">=</span> <span class="n">repo</span>

        <span class="k">if</span> <span class="n">data</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Implemented by subclasses. Reads object&#39;s contents from self.data -  a byte string - </span>
<span class="sd">        and converts it to a meaningful representation, which itself depends on the subclass&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unimplemented.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unimplemented.&quot;</span><span class="p">)</span>
</code></pre></div>

<h4>Reading objects</h4>
<p>Once we have a set of objects, a function must be created in order to retrieve and read as necessary. Consider the following function:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">object_read</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">sha</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read object {object_id} from Git repository {repo}. Return</span>
<span class="sd">    a GitObject whose exact type depends on the object&quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">repo_file</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;objects&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">sha</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

        <span class="c1"># Read object type</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">x</span><span class="p">]</span>

        <span class="c1"># Read and validate object type</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">x</span><span class="p">:</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">-</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Malformed object </span><span class="si">{</span><span class="n">sha</span><span class="si">}</span><span class="s2">: bad lenght.&quot;</span><span class="p">)</span>

        <span class="c1"># Pick constructor</span>
        <span class="k">if</span>   <span class="n">fmt</span><span class="o">==</span><span class="sa">b</span><span class="s1">&#39;commit&#39;</span> <span class="p">:</span> <span class="n">c</span><span class="o">=</span><span class="n">GitCommit</span>
        <span class="k">elif</span> <span class="n">fmt</span><span class="o">==</span><span class="sa">b</span><span class="s1">&#39;tree&#39;</span>   <span class="p">:</span> <span class="n">c</span><span class="o">=</span><span class="n">GitTree</span>
        <span class="k">elif</span> <span class="n">fmt</span><span class="o">==</span><span class="sa">b</span><span class="s1">&#39;tag&#39;</span>    <span class="p">:</span> <span class="n">c</span><span class="o">=</span><span class="n">GitTag</span>
        <span class="k">elif</span> <span class="n">fmt</span><span class="o">==</span><span class="sa">b</span><span class="s1">&#39;blob&#39;</span>   <span class="p">:</span> <span class="n">c</span><span class="o">=</span><span class="n">GitBlob</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unkown type </span><span class="si">{</span><span class="n">fmt</span><span class="o">.</span><span class="n">decode</span><span class="s1">&#39;ascii&#39;</span><span class="si">}</span><span class="s2"> for object </span><span class="si">{</span><span class="n">sha</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Call constructor and return object</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">raw</span><span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
</code></pre></div>

<p>The function begins by creating a <code>path</code> to a specific object based on the SHA-1 hash of that object. It uses the <code>repo_file</code> function defined earlier in the code, which itself is simply generating a path by joining  the repo's root directory, the objects directory and then a directory based on the first two characters of the objects hash as a directory plus the rest as a file name.</p>
<p>Once found, this function will open that specific file in <code>rb</code> mode - it will be read-only and it will be read as bytes instead of trying to apply a <code>utf-8</code> or other encoding to represent the string of bytes. With this, the function then uses <code>zlib</code> to decompress the object so that in can be processed in the following steps:</p>
<ol>
<li>Find the first empty space, <code>b" "</code> (<code>0x20</code> in ASCII), in order to get the object's headers and format.</li>
<li>Then we find the null separator, <code>b"\x00"</code> in the byte string starting immediately after the empty space we found before.</li>
<li>Once we found the null separator, we take everything after the headers to null and check the size as an ASCII-decoded <code>int</code>. This value should match the length of the commit itself</li>
<li>Once validated we can select which object constructor subclass to use.</li>
</ol>
<h4>Writing Objects</h4>
<p>Writing an object works in the same way as reading it, but in reverse:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">object_write</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">actually_write</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># Serialize object data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
    <span class="c1"># Add header</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">fmt</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">data</span>
    <span class="c1"># Compute hash</span>
    <span class="n">sha</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">actually_write</span><span class="p">:</span>
        <span class="c1"># Compute path</span>
        <span class="n">path</span><span class="o">=</span><span class="n">repo_file</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span> <span class="s2">&quot;objects&quot;</span><span class="p">,</span> <span class="n">sha</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">sha</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">mkdir</span><span class="o">=</span><span class="n">actually_write</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># Compress and write</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">sha</span>
</code></pre></div>

<ol>
<li>We start by taking our GitObject and serialising it into a byte stream (this is to have a byte-by-byte identical copy of the object saved on the file system).</li>
<li>We then prepend the serialised data with our format header, the empty space, <code>b' '</code>, the encoded length of our data, and the null separator</li>
<li>We then take the resulting byte string and hash it with the SHA-1 algorithm</li>
<li>Finally, we find an appropriate path for the new file and we open said file in <code>wb</code> (write bytes) mode. Here, we simply write the compressed result.</li>
</ol>
<h4>Packfiles</h4>
<p>The object store that is generated with the above code is known as "loose object" storage. While good, proper Git software will implement a more efficient and complex storage mechanism called a <a href="https://git-scm.com/book/en/v2/Git-Internals-Packfiles"><em>packfile</em></a>. These are a complication of various lose objects, with the caveat that some of those objects are stored as deltas (or transformations of other objects).</p>
<p>These packfiles are stored in <code>.git/objects/pack/</code> and are written with a <code>.pack</code> extension along side an index of the same name with a <code>.idx</code> extension. </p>
<h4>Blob objects</h4>
<p>A blob is a "binary large object"</p>
<p>The simplest type of git object is a <code>blob</code> because they have not actual format: they are just user content without predefined syntax or constraints. In other words, every file we place in git is a <code>blob</code>. </p>
<p>As a result of this, implementing a <code>GitBlob</code> is fairly straight forward: it simply needs to store and return its own input unmodified:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">GitBlob</span><span class="p">(</span><span class="n">GitObject</span><span class="p">):</span>
    <span class="n">fmt</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;blob&#39;</span>

    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">blobdata</span>

    <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blobdata</span> <span class="o">=</span> <span class="n">data</span>
</code></pre></div>

<h4>Parsing commits</h4>
<p>A commit object (when uncompressed and without headers) format is a simplified version of mail messages from <a href="https://www.ietf.org/rfc/rfc2822.txt">RFC2811</a>. The object itself looks like this (this commit message is taken from <code>wyag</code>):</p>
<div class="highlight"><pre><span></span><code><span class="n">tree</span><span class="w"> </span><span class="mi">29</span><span class="n">ff16c9c14e2652b22f8b78bb08a5a07930c147</span>
<span class="n">parent</span><span class="w"> </span><span class="mf">206941306e8</span><span class="n">a8af65b66eaaaea388a7ae24d49a0</span>
<span class="n">author</span><span class="w"> </span><span class="n">Thibault</span><span class="w"> </span><span class="n">Polge</span><span class="w"> </span><span class="o">&lt;</span><span class="n">thibault</span><span class="nv">@thb</span><span class="p">.</span><span class="n">lt</span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1527025023</span><span class="w"> </span><span class="o">+</span><span class="mi">0200</span>
<span class="n">committer</span><span class="w"> </span><span class="n">Thibault</span><span class="w"> </span><span class="n">Polge</span><span class="w"> </span><span class="o">&lt;</span><span class="n">thibault</span><span class="nv">@thb</span><span class="p">.</span><span class="n">lt</span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1527025044</span><span class="w"> </span><span class="o">+</span><span class="mi">0200</span>
<span class="n">gpgsig</span><span class="w"> </span><span class="o">-----</span><span class="k">BEGIN</span><span class="w"> </span><span class="n">PGP</span><span class="w"> </span><span class="n">SIGNATURE</span><span class="o">-----</span>

<span class="w"> </span><span class="n">iQIzBAABCAAdFiEExwXquOM8bWb4Q2zVGxM2FxoLkGQFAlsEjZQACgkQGxM2FxoL</span>
<span class="w"> </span><span class="n">kGQdcBAAqPP</span><span class="o">+</span><span class="n">ln4nGDd2gETXjvOpOxLzIMEw4A9gU6CzWzm</span><span class="o">+</span><span class="n">oB8mEIKyaH0UFIPh</span>
<span class="w"> </span><span class="n">rNUZ1j7</span><span class="o">/</span><span class="n">ZGFNeBDtT55LPdPIQw4KKlcf6kC8MPWP3qSu3xHqx12C5zyai2duFZUU</span>
<span class="w"> </span><span class="n">wqOt9iCFCscFQYqKs3xsHI</span><span class="o">+</span><span class="n">ncQb</span><span class="o">+</span><span class="n">PGjVZA8</span><span class="o">+</span><span class="n">jPw7nrPIkeSXQV2aZb1E68wa2YIL</span>
<span class="w"> </span><span class="mi">3</span><span class="n">eYgTUKz34cB6tAq9YwHnZpyPx8UJCZGkshpJmgtZ3mCbtQaO17LoihnqPn4UOMr</span>
<span class="w"> </span><span class="n">V75R</span><span class="o">/</span><span class="mi">7</span><span class="n">FjSuPLS8NaZF4wfi52btXMSxO</span><span class="o">/</span><span class="n">u7GuoJkzJscP3p4qtwe6Rl9dc1XC8P7k</span>
<span class="w"> </span><span class="n">NIbGZ5Yg5cEPcfmhgXFOhQZkD0yxcJqBUcoFpnp2vu5XJl2E5I</span><span class="o">/</span><span class="n">quIyVxUXi6O6c</span>
<span class="w"> </span><span class="o">/</span><span class="n">obspcvace4wy8uO0bdVhc4nJ</span><span class="o">+</span><span class="n">Rla4InVSJaUaBeiHTW8kReSFYyMmDCzLjGIu1q</span>
<span class="w"> </span><span class="n">doU61OM3Zv1ptsLu3gUE6GU27iWYj2RWN3e3HE4Sbd89IFwLXNdSuM0ifDLZk7AQ</span>
<span class="w"> </span><span class="n">WBhRhipCCgZhkj9g2NEk7jRVslti1NdN5zoQLaJNqSwO1MtxTmJ15Ksk3QP6kfLB</span>
<span class="w"> </span><span class="n">Q52UWybBzpaP9HEd4XnR</span><span class="o">+</span><span class="n">HuQ4k2K0ns2KgNImsNvIyFwbpMUyUWLMPimaV1DWUXo</span>
<span class="w"> </span><span class="mi">5</span><span class="n">SBjDB</span><span class="o">/</span><span class="n">V</span><span class="o">/</span><span class="n">W2JBFR</span><span class="o">+</span><span class="n">XKHFJeFwYhj7DD</span><span class="o">/</span><span class="n">ocsGr4ZMx</span><span class="o">/</span><span class="n">lgc8rjIBkI</span><span class="o">=</span>
<span class="w"> </span><span class="o">=</span><span class="n">lgTX</span>
<span class="w"> </span><span class="o">-----</span><span class="k">END</span><span class="w"> </span><span class="n">PGP</span><span class="w"> </span><span class="n">SIGNATURE</span><span class="o">-----</span>

<span class="k">Create</span><span class="w"> </span><span class="k">first</span><span class="w"> </span><span class="n">draft</span>
</code></pre></div>

<p>The format begins with a series of key-value pairs separate by a space and ends with a commit message. The fields are as follows:</p>
<ul>
<li><code>tree</code> is a reference to a tree object. It maps blobs IDs to filesystem locations and describes a state of the worktree. It is the actual content of the commit: files and where they should be.</li>
<li><code>parent</code> is the parent of the current commit. This may be repeated, as is the case for merge commits that may have multiple commits, or may be entirely absent as would be the case for an initial commit.</li>
<li><code>author</code> and <code>committer</code> are separate values because the author may not be the same person who can create the commit</li>
<li><code>gpgsig</code> is the PGP signature of this object</li>
</ul>
<p>The code to parse a message like this is as follows. Note that the function is called <code>kvlm_parse</code> because it is designed to parse key-value lists with messages. The same format is used for both commits and tags:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">kvlm_parse</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dct</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dct</span><span class="p">:</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="c1"># You CANNOT declare the argument as dct=OrderedDict() or all</span>
        <span class="c1"># call to the functions will endlessly grow the same dict.</span>

    <span class="c1"># We search for the next space and the next newline.</span>
    <span class="n">spc</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
    <span class="n">nl</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>

    <span class="c1"># If space appears before newline, we have a keyword.</span>

    <span class="c1"># Base case</span>
    <span class="c1"># =========</span>
    <span class="c1"># If newline appears first (or there&#39;s no space at all, in which</span>
    <span class="c1"># case find returns -1), we assume a blank line.  A blank line</span>
    <span class="c1"># means the remainder of the data is the message.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">spc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">nl</span> <span class="o">&lt;</span> <span class="n">spc</span><span class="p">):</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">nl</span> <span class="o">==</span> <span class="n">start</span><span class="p">)</span>
        <span class="n">dct</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">dct</span>

    <span class="c1"># Recursive case</span>
    <span class="c1"># ==============</span>
    <span class="c1"># we read a key-value pair and recurse for the next.</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">spc</span><span class="p">]</span>

    <span class="c1"># Find the end of the value.  Continuation lines begin with a</span>
    <span class="c1"># space, so we loop until we find a &quot;\n&quot; not followed by a space.</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">start</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raw</span><span class="p">[</span><span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">):</span> <span class="k">break</span>

    <span class="c1"># Grab the value</span>
    <span class="c1"># Also, drop the leading space on continuation lines</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">spc</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Don&#39;t overwrite existing data contents</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dct</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">value</span> <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">value</span>

    <span class="k">return</span> <span class="n">kvlm_parse</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dct</span><span class="o">=</span><span class="n">dct</span><span class="p">)</span>
</code></pre></div>

<p>The function here starts by creating an <code>OrderedDict</code>, a Python structure that works as a dictionary but retains the order of all items in the dict (<em>Note: possibly redundant as of Python 3.6+, since this behaviour exists in regular dicts</em>). </p>
<p>We then establish where the next space is and the next newline: on the same line, the data before the space should be a key and after the space should be a value. However, if there is no space and only a newline we can assume we are at the message part of the data.</p>
<h4>The log command and graphviz</h4>
<h4>Commits</h4>
<p>When thinking about commits, it is worth remembering that work tree contents are just part of a commit, in addition to everything else: contents, authors, and parents. And thus, because the SHA-1 hash of a commit is made up from all the contents of a commit, we then have immutable commits: changing the author or anything about the author, contents, etc. will generate a new, different object with its own SHA-1 hash.</p>
<p>In other words, a commit ID not only identifies some file contents, but also binds the commit itself to its whole history and the whole repository. Notably, too, each commit is linked to its own past, but not to future commits.</p>
<p>The integral parts of a commit are:</p>
<ul>
<li>A tree object; that is, the contents of a worktree, files, and directories</li>
<li>Zero, one, or more parents</li>
<li>An author identity (name and email)</li>
<li>A committer identity (name and email)</li>
<li>An optional PGP signature</li>
<li>A message</li>
</ul>
<p>All of these things then hashed together in a SHA-1 ID.</p>
<h4>Trees</h4>
<p>A tree describes the content of the worktree. That is, it associates blobs to paths, and it is composed of an array of three-element tuples made up of a file mode, a path, and a SHA-1. A typical tree might look like this:</p>
<table>
<thead>
<tr>
<th>Mode</th>
<th>Path</th>
<th>SHA-1</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>100644</code></td>
<td><code>.gitignore</code></td>
<td><code>894a44cc066a027465cd26d634948d56d13af9af</code></td>
</tr>
<tr>
<td><code>100644</code></td>
<td><code>LICENSE</code></td>
<td><code>94a9ed024d3859793618152ea559a168bbcbb5e2</code></td>
</tr>
<tr>
<td><code>100644</code></td>
<td><code>README.md</code></td>
<td><code>bab489c4f4600a38ce6dbfd652b90383a4aa3e45</code></td>
</tr>
<tr>
<td><code>100644</code></td>
<td><code>src</code></td>
<td><code>6d208e47659a2a10f5f8640e0155d9276a2130a9</code></td>
</tr>
<tr>
<td><code>040000</code></td>
<td><code>tests</code></td>
<td><code>e7445b03aea61ec801b20d6ab62f076208b7d097</code></td>
</tr>
<tr>
<td><code>040000</code></td>
<td><code>main.c</code></td>
<td><code>d5ec863f17f3a2e92aa8f6b66ac18f7b09fd1b38</code></td>
</tr>
</tbody>
</table>
<p><code>Mode</code> refers to the file's file system permission mode, and path to it's location relative to the tree, while the SHA-1 refers to either a blob or another tree object: when its a blob, the path is a file, and when its a tree, the path is a directory.</p>
<p>In the case of the above tree contents, if we want to instantiate the tree we would begin by loading the object associated with the first path, <code>.gitignore</code> in this case, and check its type. Since it is a blob, we'll create a file called <code>.gitignore</code> with the blob's contents, and likewise for <code>LICENSE</code> and <code>README.md</code>. The next path, <code>src</code>, is a directory, and we will therefore create a <code>src</code> directory and repeat the same operation inside the new tree.</p>
<p><em>Note: a path is a single filesystem entry and it identifies exactly one object. If there are five levels of nested directories we will need five tree objects recursively referring to one another.</em></p>
<h4>Parsing trees</h4>
<p>Unlike tags and commits, tree objects are binary objects. Their format is a concatenation of the format's records:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">mode</span><span class="o">]</span><span class="w"> </span><span class="mh">0x20</span><span class="w"> </span><span class="o">[</span><span class="n">path</span><span class="o">]</span><span class="w"> </span><span class="mh">0x00</span><span class="w"> </span><span class="o">[</span><span class="n">sha-1</span><span class="o">]</span>
</code></pre></div>

<ul>
<li><code>mode</code> is an ASCII representation of a file mode, of size up to six bytes. For example, 100644 is encoded as 49 48 48 54 52 52</li>
<li>It is followed by an ASCII space, <code>0x20</code></li>
<li>Then we have the null-terminated path</li>
<li>And finally the SHA-1 in binary encoding on 20 bytes.</li>
</ul>
<p>The code to parse trees is fairly straightforward. We create a class to represent each leaf of the tree that simply contains the mode, path, and SHA of a particular object. We then use the following parsers:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">tree_parse_one</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="c1"># Find the space terminator of the mode</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">start</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">x</span><span class="o">-</span><span class="n">start</span><span class="o">==</span><span class="mi">6</span><span class="p">)</span>

    <span class="c1"># Read the mode</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">x</span><span class="p">]</span>

    <span class="c1"># Find the NULL terminator of the path</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="c1"># and read the path</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">y</span><span class="p">]</span>

    <span class="c1"># Read the SHA and convert to an hex string</span>
    <span class="n">sha</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span>
        <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span>
            <span class="n">raw</span><span class="p">[</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="mi">21</span><span class="p">],</span> <span class="s2">&quot;big&quot;</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span> <span class="c1"># hex() adds 0x in front,</span>
                                           <span class="c1"># we don&#39;t want that.</span>
    <span class="k">return</span> <span class="n">y</span><span class="o">+</span><span class="mi">21</span><span class="p">,</span> <span class="n">GitTreeLeaf</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">sha</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">tree_parse</span><span class="p">(</span><span class="n">raw</span><span class="p">):</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">:</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">tree_parse_one</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div>

<p>The first parser reads a single line of the tree. It separates the data by way of the <code>space</code> and <code>null</code> terminators, converts the SHA into hex (and removes the 0x from hex notation) and simply returns a leaf object.</p>
<p>We then use a more general tree parser that simply goes line by line an returns all the leaves together.</p>
<h4>Refs</h4>
<p>Git references, or refs, live in subdirectories of <code>.git/refs</code>. They are text files that contain a hexadecimal representation of an object's hash, encoded in ASCII. They look like this:</p>
<div class="highlight"><pre><span></span><code><span class="mf">6071</span><span class="n">c08bcb4757d8c89a30d9755d2466cef8c1de</span>
</code></pre></div>

<p>They can also refer to another reference and thereby indirectly to an object. In this case, they look like this:</p>
<div class="highlight"><pre><span></span><code><span class="n">ref</span><span class="o">:</span><span class="w"> </span><span class="n">refs</span><span class="sr">/remotes/origin/</span><span class="n">master</span>
</code></pre></div>

<p>To work with refs we start with a resolver that takes a ref name and follow recursive references until it returns a SHA-1:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">ref_resolve</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">repo_file</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">ref</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Drop final \n ^^^^^</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ref: &quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ref_resolve</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<p>Once we can resolve a single ref, the rest of the code simply involves collecting the relevant refs into a data structure and printing them in order.</p>
<h4>Tags</h4>
<p>The simplest use of refs is tags (in fact, tags live at <code>.git/refs/tags</code>). These are just user-defined names for an object. They can be used to identify specific releases; rather than referring to a particular commit by a hash, say <code>4324c09</code>, we can tag it with <code>v3.11.75</code>. The result is that the following two commands become equivalent:</p>
<div class="highlight"><pre><span></span><code>git checkout 4324c09
git checkout v3.11.75
</code></pre></div>

<p>Note that we can use tags to name anything, including blobs.</p>
<p>There are two types of tags: "lightweight tags", which are regular refs to a commit, tree, or blob, and "tag objects" which are regular tags to a <code>tag</code> object. The latter have authors, a date, an optional PGP signature, and optional annotation, and they have the same format as a commit object.</p>
<p>Because they use the commit object, implementing tags is as easy as:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">GitTag</span><span class="p">(</span><span class="n">GitCommit</span><span class="p">):</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;tag&#39;</span>
</code></pre></div>

<p>In Git, the tag command does two things: either it creates a new tag or it lists existing tags. </p>
<h4>Branches</h4>
<p>A branch is just a reference to a specific commit. In a way, a branch is just a name for a commit, and therefore almost exactly the same as a tag. In fact, branches live at <code>.git/refs/heads</code>.</p>
<p>There are some differences:</p>
<ol>
<li>Branches are references to a commit, while a tag can refer to any object.</li>
<li>The branch ref is updated at each commit. In other words, whenever we make a commit:<ol>
<li>a new commit object is created, with the current branch's ID as its parent</li>
<li>the commit object is hashed and stored</li>
<li>the branch ref is updated to refer to the new commit's hash</li>
</ol>
</li>
</ol>
<p>The current branch is simply a ref file outside the <code>refs</code> hierarchy, located at <code>.git/HEAD</code>. It is formatted as an <em>indirect</em> reference.</p>
<h4>Resolving names</h4>
<p>Git uses a name resolution algorithm to resolve names such as <code>HEAD</code>, hashes, short hashes, as well as tags and branches matching a given name.</p>
<p>The way it works is as follows:</p>
<ol>
<li>If <code>name</code> is HEAD, it will resolve <code>.git/HEAD</code></li>
<li>If <code>name</code> is a full hash, return the hash unmodified</li>
<li>If <code>name</code> looks like a short hash, return objects whose full hash start with this short hash</li>
<li>Resolve tags and branches matching <code>name</code></li>
</ol>
<hr>
<p><em>Aside: Short hashes</em></p>
<p>Short hashes are simply a convenience provided by Git to refer to specific objects. For example, <code>5bd254aa973646fa16f66d702a5826ea14a3eb45</code> can be referred to as <code>5bd254</code></p>
<hr>
<p>Once a specific hash or name has been found we can follow it until we find an object of the required type, assuming a type argument was provided:</p>
<ul>
<li>If we have a tag and <code>fmt</code> is anything else, we follow the tag</li>
<li>If we have a commit and <code>fmt</code> is tree, we return this commit's tree object</li>
<li>Otherwise we abort</li>
</ul>
<h4>Staging and the index</h4>
<p>When creating a new commit, we first <em>stage</em> our files and then commit. The way files are staged is making making use of an <code>index</code> file: it represents a set of changes from the HEAD commit; when committing, the changes on the index file must be combined to create a new commit.</p>
<p>The index is made up of three parts:
* A header with a signature and some basic info (such as the number of entries it holds)
* A series of sorted entries where each represents a change
* A series of optional extensions</p>
    <footer>
      <p>Published: <time datetime="2022-08-24T00:00:00-07:00">
        Wed 24 August 2022
      </time></p>
        <p>Last updated: <time datetime="2024-10-04T23:08:49.062296-07:00">
          Fri 04 October 2024
        </time></p>
        <address>
          By             <a href="../">Adnan Valdes</a>
        </address>
        <p>
          Category: <a href="../category/blog.html">blog</a>
        </p>
        <p>
          Tags:
            <a href="../tag/programming.html">programming</a>
        </p>
    </footer>
  </article>
  </main>
  <footer>
    <nav class="nav">
      <ul class="nav__ul">
        [
        <li>
          <a href="mailto:adnan@av-b.net" target="_blank">Email</a>
        </li>
        ][
        <li>
          <a href="https://github.com/adnanvaldes" target="_blank">Github</a>
        </li>
        ][
        <li>
          <a href="https://www.linkedin.com/in/adnanvaldes/" target="_blank">LinkedIn</a>
        </li>
        ]
      </ul>
    </nav>
  </footer>
  </body>
</html>